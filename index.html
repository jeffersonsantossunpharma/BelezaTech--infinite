<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BelezaTech Infinite - Gest√£o Inteligente</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8B5CF6">
    <meta name="description" content="Sistema completo de gest√£o para sal√µes de beleza com IA integrada">
    
    <!-- PWA Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíá</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíá</text></svg>">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    
    <!-- Environment Variables - COLOQUE SUAS CHAVES AQUI -->
    <script>
        window.ENV = {
            SUPABASE_URL: "https://lkuzedzomsjvuqzdjmce.supabase.co",
            SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrdXplZHpvbXNqdnVxemRqbWNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMTYyMzQsImV4cCI6MjA3Mzc5MjIzNH0.ZbttIozU7VlTpravG2ZI4RtaPI1QNdizWTx5W1mpTjI",
            GEMINI_API_KEY: "AIzaSyDc2hXz3w_slDRgIGzP3Mey5iwWWqc9nrE"
        };
    </script>
    
    <style>
        :root {
            --primary-color: #8B5CF6;
            --secondary-color: #F3E8FF;
            --accent-color: #10B981;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, #6D28D9 100%);
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            margin: 4px 0;
            border-radius: 8px;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .card {
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        .metric-card {
            background: white;
            border-left: 4px solid var(--primary-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #7c3aed;
            border-color: #7c3aed;
        }

        /* Chatbot */
        .chatbot-container { position: fixed; bottom: 20px; right: 20px; z-index: 1050; }
        .chatbot-toggle {
            width: 60px; height: 60px; border-radius: 50%; background: var(--primary-color);
            border: none; color: white; font-size: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            cursor: pointer; transition: transform 0.3s;
        }
        .chatbot-toggle:hover { transform: scale(1.1); }
        .chatbot-window {
            position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px;
            background: white; border-radius: 16px; box-shadow: 0 5px 40px rgba(0,0,0,0.16);
            display: none; flex-direction: column; overflow: hidden;
        }
        .chatbot-header {
            background: var(--primary-color); color: white; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chatbot-messages { flex: 1; overflow-y: auto; padding: 15px; background: #f1f5f9; }
        .chat-message { margin-bottom: 12px; display: flex; }
        .chat-message.user { justify-content: flex-end; }
        .message-bubble {
            max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 14px;
        }
        .message-bubble.bot { background: white; color: #334155; border-bottom-left-radius: 4px; }
        .message-bubble.user { background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        .chatbot-input { padding: 15px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; }
        .chat-input { flex: 1; border-radius: 20px; border: 1px solid #cbd5e1; padding: 8px 15px; }

        /* PWA Prompt */
        .pwa-install-prompt {
            position: fixed; bottom: 20px; left: 20px; right: 20px; background: white;
            padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none; z-index: 1000;
        }
        .pwa-install-prompt.show { display: flex; justify-content: space-between; align-items: center; }

        /* Utilities */
        .hidden { display: none !important; }
        .loading { opacity: 0.7; pointer-events: none; }
        
        /* Time slots */
        .time-slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px; }
        .time-slot {
            padding: 8px; border: 1px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer;
        }
        .time-slot.available:hover { border-color: var(--primary-color); background: #f3e8ff; }
        .time-slot.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        .time-slot.disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
    </style>
</head>
<body>

    <!-- PWA Install Prompt -->
    <div id="pwaInstallPrompt" class="pwa-install-prompt">
        <div>
            <strong>Instalar BelezaTech</strong>
            <p class="mb-0 small text-muted">Acesse rapidamente pela sua tela inicial.</p>
        </div>
        <div>
            <button class="btn btn-sm btn-link text-muted" id="dismissInstall">Depois</button>
            <button class="btn btn-sm btn-primary" id="installPWA">Instalar</button>
        </div>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-container">
        <button class="chatbot-toggle" id="chatbotToggle"><i class="fas fa-comments"></i></button>
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h6 class="mb-0">Assistente Virtual</h6>
                <button class="btn btn-sm text-white" id="closeChatbot"><i class="fas fa-times"></i></button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <!-- Messages here -->
            </div>
            <div class="chatbot-input">
                <input type="text" class="chat-input" id="chatInput" placeholder="Digite sua d√∫vida...">
                <button class="btn btn-primary rounded-circle" id="chatSendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- 1. AUTH SCREEN -->
    <div id="authScreen" class="container-fluid vh-100 d-flex align-items-center justify-content-center">
        <div class="card p-5" style="width: 100%; max-width: 400px;">
            <div class="text-center mb-4">
                <h3 class="fw-bold text-primary">BelezaTech Infinite</h3>
                <p class="text-muted">Gest√£o Inteligente de Sal√µes</p>
            </div>
            <form id="authForm">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3" id="authSubmitBtn">
                    <span id="authButtonText">Entrar</span>
                    <span class="spinner-border spinner-border-sm d-none" id="authSpinner"></span>
                </button>
                <p class="text-center mb-0">
                    <a href="#" id="toggleAuth" class="text-decoration-none">N√£o tem conta? Cadastre-se</a>
                </p>
            </form>
        </div>
    </div>

    <!-- 2. ONBOARDING SCREEN -->
    <div id="onboardingScreen" class="container-fluid py-5 hidden">
        <div class="card mx-auto" style="max-width: 600px;">
            <div class="card-body p-5">
                <h4 class="card-title mb-4">Configura√ß√£o Inicial</h4>
                
                <!-- Step 1: Dados do Sal√£o -->
                <div id="onboardingStep1" class="onboarding-step">
                    <h5>Passo 1: Informa√ß√µes do Sal√£o</h5>
                    <div class="mb-3">
                        <label class="form-label">Nome do Sal√£o</label>
                        <input type="text" class="form-control" id="salonName" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Telefone</label><input type="text" id="salonPhone" class="form-control"></div>
                        <div class="col-md-6 mb-3"><label>Endere√ßo</label><input type="text" id="salonAddress" class="form-control"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Abre (ex: 08:00)</label><input type="time" id="salonOpen" class="form-control" value="09:00"></div>
                        <div class="col-md-6 mb-3"><label>Fecha (ex: 18:00)</label><input type="time" id="salonClose" class="form-control" value="19:00"></div>
                    </div>
                </div>

                <!-- Step 2: Identidade Visual -->
                <div id="onboardingStep2" class="onboarding-step hidden">
                    <h5>Passo 2: Identidade Visual</h5>
                    <div class="mb-3">
                        <label class="form-label">Logo do Sal√£o</label>
                        <input type="file" class="form-control" id="salonLogo" accept="image/*">
                    </div>
                    <label class="form-label">Cor Principal</label>
                    <input type="color" class="form-control form-control-color w-100" id="salonColor" value="#8B5CF6" title="Escolha a cor">
                </div>

                <!-- Step 3: Servi√ßos Iniciais -->
                <div id="onboardingStep3" class="onboarding-step hidden">
                    <h5>Passo 3: Servi√ßos Principais</h5>
                    <div id="initialServicesList">
                        <div class="service-row row mb-2">
                            <div class="col-5"><input type="text" class="form-control" placeholder="Nome (ex: Corte)" value="Corte Feminino"></div>
                            <div class="col-3"><input type="number" class="form-control" placeholder="Pre√ßo" value="80"></div>
                            <div class="col-4"><input type="number" class="form-control" placeholder="Minutos" value="60"></div>
                        </div>
                         <div class="service-row row mb-2">
                            <div class="col-5"><input type="text" class="form-control" placeholder="Nome" value="Escova"></div>
                            <div class="col-3"><input type="number" class="form-control" placeholder="Pre√ßo" value="45"></div>
                            <div class="col-4"><input type="number" class="form-control" placeholder="Minutos" value="30"></div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary mt-2" id="addServiceRowBtn">+ Adicionar Servi√ßo</button>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-light" id="prevStepBtn" disabled>Voltar</button>
                    <button class="btn btn-primary" id="nextStepBtn">Pr√≥ximo</button>
                    <button class="btn btn-success hidden" id="finishOnboardingBtn">Concluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. DASHBOARD (Main App) -->
    <div id="dashboardScreen" class="hidden">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-auto col-md-3 col-xl-2 sidebar collapse show" id="sidebarMenu">
                <div class="d-flex flex-column p-3 text-white min-vh-100">
                    <a href="#" class="d-flex align-items-center mb-3 text-white text-decoration-none">
                        <img id="dashboardLogo" src="" alt="" width="32" height="32" class="rounded-circle me-2 hidden">
                        <span class="fs-5" id="dashboardSalonName">BelezaTech</span>
                    </a>
                    <hr>
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-home me-2"></i> Dashboard</a>
                        </li>
                        <li><a href="#" class="nav-link text-white" data-page="agenda"><i class="fas fa-calendar-alt me-2"></i> Agenda</a></li>
                        <li><a href="#" class="nav-link text-white" data-page="clients"><i class="fas fa-users me-2"></i> Clientes</a></li>
                        <li><a href="#" class="nav-link text-white" data-page="services"><i class="fas fa-cut me-2"></i> Servi√ßos</a></li>
                        <li><a href="#" class="nav-link text-white" data-page="stock"><i class="fas fa-box me-2"></i> Estoque</a></li>
                        <li><a href="#" class="nav-link text-white" data-page="payments"><i class="fas fa-cash-register me-2"></i> Pagamentos</a></li>
                        <li><a href="#" class="nav-link text-white" data-page="public"><i class="fas fa-external-link-alt me-2"></i> Portal P√∫blico</a></li>
                    </ul>
                    <hr>
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i>
                            <strong id="userEmailDisplay">Admin</strong>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li><a class="dropdown-item" href="#" id="logoutBtn">Sair</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-9 col-xl-10 p-4" style="background: #f1f5f9; min-height: 100vh;">
                
                <!-- Page: Dashboard -->
                <div id="page-dashboard" class="dashboard-page">
                    <h2 class="mb-4">Dashboard</h2>
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card metric-card p-3">
                                <h6 class="text-muted">Faturamento Hoje</h6>
                                <h3 id="kpiRevenue">R$ 0,00</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card p-3">
                                <h6 class="text-muted">Agendamentos</h6>
                                <h3 id="kpiAppointments">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card p-3">
                                <h6 class="text-muted">Clientes Ativos</h6>
                                <h3 id="kpiClients">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card p-3">
                                <h6 class="text-muted">Taxa Ocupa√ß√£o</h6>
                                <h3 id="kpiOccupancy">0%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-3 mb-4">
                                <h6>Faturamento Semanal</h6>
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3">
                                <h6><i class="fas fa-robot"></i> Insight IA</h6>
                                <p id="aiInsight" class="small text-muted">Carregando insight...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page: Agenda -->
                <div id="page-agenda" class="dashboard-page hidden">
                     <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Agenda</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#appointmentModal">+ Novo Agendamento</button>
                    </div>
                    <div class="card p-3">
                        <div id="calendar">Agenda (Implementa√ß√£o futura com lib de calend√°rio)</div>
                        <p>Agendamentos de hoje:</p>
                        <div id="todayAppointmentsList"></div>
                    </div>
                </div>

                <!-- Page: Clientes (CRM) -->
                <div id="page-clients" class="dashboard-page hidden">
                     <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Clientes</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientModal">+ Novo Cliente</button>
                    </div>
                    <div class="card">
                        <div class="card-body" id="clientsTableContainer">
                             <table class="table table-hover">
                                 <thead><tr><th>Nome</th><th>Telefone</th><th>√öltima Visita</th><th>A√ß√µes</th></tr></thead>
                                 <tbody id="clientsTableBody"></tbody>
                             </table>
                        </div>
                    </div>
                </div>
                
                <!-- Page: Servi√ßos -->
                 <div id="page-services" class="dashboard-page hidden">
                     <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Servi√ßos</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#serviceModal">+ Novo Servi√ßo</button>
                    </div>
                    <div class="row" id="servicesGrid"></div>
                 </div>

                <!-- Page: Estoque -->
                 <div id="page-stock" class="dashboard-page hidden">
                     <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Estoque</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">+ Novo Produto</button>
                    </div>
                     <div class="row" id="productsGrid"></div>
                 </div>

                <!-- Page: Portal P√∫blico -->
                <div id="page-public" class="dashboard-page hidden">
                    <h2>Portal do Cliente</h2>
                    <div class="card p-4">
                        <p>Compartilhe este link com seus clientes para que eles possam agendar servi√ßos online:</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="publicLink" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn"><i class="fas fa-copy"></i></button>
                        </div>
                        <a href="#" id="viewPublicPortalBtn" class="btn btn-primary" target="_blank">Visualizar Portal</a>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 4. PUBLIC PORTAL (Client View) -->
    <div id="publicPortal" class="container py-5 hidden">
        <div class="text-center mb-4">
            <img id="publicSalonLogo" src="" alt="" height="60" class="mb-3">
            <h1 id="publicSalonName"></h1>
        </div>

        <div class="card mx-auto" style="max-width: 600px;">
            <div class="card-body">
                <h4 class="mb-4">Agendar Hor√°rio</h4>
                <form id="publicBookingForm">
                    <div class="mb-3">
                        <label>Escolha o Servi√ßo</label>
                        <select class="form-select" id="bookingService" required></select>
                    </div>
                    <div class="mb-3">
                        <label>Data</label>
                        <input type="date" class="form-control" id="bookingDate" required>
                    </div>
                    <div class="mb-3">
                        <label>Hor√°rio Dispon√≠vel</label>
                        <div id="timeSlots" class="time-slots"></div>
                        <input type="hidden" id="bookingTime">
                    </div>

                    <hr class="my-4">
                    <h5>Seus Dados</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3"><input type="text" class="form-control" id="bookingName" placeholder="Nome" required></div>
                        <div class="col-md-6 mb-3"><input type="tel" class="form-control" id="bookingPhone" placeholder="Telefone" required></div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100">Confirmar Agendamento</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Modal Novo Cliente -->
    <div class="modal fade" id="clientModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Novo Cliente</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="clientForm">
                <div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="c_name" required></div>
                <div class="mb-3"><label>Telefone</label><input type="tel" class="form-control" id="c_phone" required></div>
                <div class="mb-3"><label>Email</label><input type="email" class="form-control" id="c_email"></div>
                <div class="mb-3"><label>Notas</label><textarea class="form-control" id="c_notes"></textarea></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" id="saveClientBtn">Salvar</button></div>
    </div></div></div>

    <!-- Modal Novo Servi√ßo -->
    <div class="modal fade" id="serviceModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Novo Servi√ßo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="serviceForm">
                <div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="s_name" required></div>
                <div class="row">
                    <div class="col-6 mb-3"><label>Pre√ßo (R$)</label><input type="number" step="0.01" class="form-control" id="s_price" required></div>
                    <div class="col-6 mb-3"><label>Dura√ß√£o (min)</label><input type="number" class="form-control" id="s_duration" required></div>
                </div>
                <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="s_active" checked><label>Ativo para agendamento</label></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" id="saveServiceBtn">Salvar</button></div>
    </div></div></div>
    
    <!-- Modal Novo Produto -->
     <div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Novo Produto</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="productForm">
                <div class="mb-3"><label>Nome</label><input type="text" class="form-control" id="p_name" required></div>
                 <div class="row">
                    <div class="col-6 mb-3"><label>Categoria</label><input type="text" class="form-control" id="p_category"></div>
                    <div class="col-6 mb-3"><label>Quantidade</label><input type="number" class="form-control" id="p_quantity" value="0"></div>
                </div>
                <div class="mb-3"><label>Descri√ß√£o (IA pode gerar)</label><textarea class="form-control" id="p_desc"></textarea>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="generateDescBtn">Gerar com IA</button>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" id="saveProductBtn">Salvar</button></div>
    </div></div></div>


    <script>
        // --- CONFIG & INIT ---
        const supabase = window.supabase.createClient(window.ENV.SUPABASE_URL, window.ENV.SUPABASE_ANON_KEY);
        let currentUser = null;
        let currentSalon = null;
        let currentOnboardingStep = 1;

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            initializeApp();
            initPWA();
            initChatbot();
        });

        async function initializeApp() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                handleUserSession(session.user);
            } else {
                showScreen('authScreen');
            }
            setupEventListeners();
        }

        async function handleUserSession(user) {
            currentUser = user;
            document.getElementById('userEmailDisplay').textContent = user.email.split('@')[0];
            
            // Tentar carregar sal√£o do usu√°rio
            const { data: salon } = await supabase.from('salons').select('*').eq('user_id', user.id).maybeSingle();

            if (salon) {
                currentSalon = salon;
                showScreen('dashboardScreen');
                updateDashboardUI();
            } else {
                showScreen('onboardingScreen');
            }
        }

        // --- UTILS ---
        function showScreen(screenId) {
            ['authScreen', 'onboardingScreen', 'dashboardScreen', 'publicPortal'].forEach(id => {
                document.getElementById(id)?.classList.add('hidden');
            });
            document.getElementById(screenId)?.classList.remove('hidden');
        }

        function showLoading(btnId, show = true) {
            const btn = document.getElementById(btnId);
            const spinner = btn.querySelector('.spinner-border');
            const text = btn.querySelector('span:not(.spinner-border)');
            
            btn.disabled = show;
            spinner.classList.toggle('d-none', !show);
            text.style.opacity = show ? 0.5 : 1;
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Auth
            document.getElementById('authForm').addEventListener('submit', handleAuthSubmit);
            document.getElementById('toggleAuth').addEventListener('click', toggleAuthMode);
            document.getElementById('logoutBtn').addEventListener('click', async () => { await supabase.auth.signOut(); });

            // Onboarding
            document.getElementById('nextStepBtn').addEventListener('click', nextOnboardingStep);
            document.getElementById('prevStepBtn').addEventListener('click', prevOnboardingStep);
            document.getElementById('finishOnboardingBtn').addEventListener('click', finishOnboarding);
            document.getElementById('addServiceRowBtn').addEventListener('click', addServiceRow);

            // Dashboard Navigation
            document.querySelectorAll('[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showDashboardPage(e.target.closest('a').dataset.page);
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    e.target.closest('a').classList.add('active');
                });
            });

            // Modals (Save Buttons)
            document.getElementById('saveClientBtn').addEventListener('click', saveClient);
            document.getElementById('saveServiceBtn').addEventListener('click', saveService);
            document.getElementById('saveProductBtn').addEventListener('click', saveProduct);

            // Public Portal
            document.getElementById('bookingDate').addEventListener('change', loadTimeSlots);
            document.getElementById('publicBookingForm').addEventListener('submit', submitPublicBooking);

            // IA
            document.getElementById('generateDescBtn').addEventListener('click', generateProductDescription);
        }

        // --- AUTHENTICATION ---
        async function handleAuthSubmit(e) {
            e.preventDefault();
            showLoading('authSubmitBtn', true);
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const isLogin = document.getElementById('authButtonText').textContent === 'Entrar';

            try {
                const { data, error } = isLogin 
                    ? await supabase.auth.signInWithPassword({ email, password })
                    : await supabase.auth.signUp({ email, password });

                if (error) throw error;

                if (!isLogin && data.user) {
                    alert('Cadastro realizado! Verifique seu e-mail para confirmar.');
                } else {
                    handleUserSession(data.user);
                }

            } catch (error) {
                alert(error.message);
            } finally {
                showLoading('authSubmitBtn', false);
            }
        }

        function toggleAuthMode(e) {
            e.preventDefault();
            const btnText = document.getElementById('authButtonText');
            const link = document.getElementById('toggleAuth');
            if (btnText.textContent === 'Entrar') {
                btnText.textContent = 'Cadastrar';
                link.textContent = 'J√° tem conta? Entre';
            } else {
                btnText.textContent = 'Entrar';
                link.textContent = 'N√£o tem conta? Cadastre-se';
            }
        }

        // --- ONBOARDING ---
        function updateOnboardingUI() {
            document.querySelectorAll('.onboarding-step').forEach(s => s.classList.add('hidden'));
            document.getElementById(`onboardingStep${currentOnboardingStep}`).classList.remove('hidden');
            
            document.getElementById('prevStepBtn').disabled = currentOnboardingStep === 1;
            document.getElementById('nextStepBtn').classList.toggle('hidden', currentOnboardingStep === 3);
            document.getElementById('finishOnboardingBtn').classList.toggle('hidden', currentOnboardingStep < 3);
        }
        function nextOnboardingStep() { if (currentOnboardingStep < 3) { currentOnboardingStep++; updateOnboardingUI(); } }
        function prevOnboardingStep() { if (currentOnboardingStep > 1) { currentOnboardingStep--; updateOnboardingUI(); } }
        
        function addServiceRow() {
            const list = document.getElementById('initialServicesList');
            const div = document.createElement('div');
            div.className = 'service-row row mb-2';
            div.innerHTML = `
                <div class="col-5"><input type="text" class="form-control" placeholder="Nome"></div>
                <div class="col-3"><input type="number" class="form-control" placeholder="Pre√ßo"></div>
                <div class="col-4"><input type="number" class="form-control" placeholder="Minutos"></div>
            `;
            list.appendChild(div);
        }

        async function finishOnboarding() {
            showLoading('finishOnboardingBtn', true);
            try {
                // 1. Salvar Sal√£o
                const { data: salon, error: sError } = await supabase.from('salons').insert([{
                    user_id: currentUser.id,
                    name: document.getElementById('salonName').value,
                    phone: document.getElementById('salonPhone').value,
                    address: document.getElementById('salonAddress').value,
                    open_time: document.getElementById('salonOpen').value,
                    close_time: document.getElementById('salonClose').value,
                    primary_color: document.getElementById('salonColor').value,
                    // Logo upload seria feito aqui via Storage
                }]).select().single();

                if (sError) throw sError;
                currentSalon = salon;

                // 2. Salvar Servi√ßos Iniciais
                const services = [];
                document.querySelectorAll('#initialServicesList .service-row').forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    if (inputs[0].value) {
                        services.push({
                            salon_id: salon.id,
                            name: inputs[0].value,
                            price: inputs[1].value || 0,
                            duration: inputs[2].value || 30
                        });
                    }
                });

                if (services.length > 0) {
                    const { error: servError } = await supabase.from('services').insert(services);
                    if (servError) throw servError;
                }

                handleUserSession(currentUser);

            } catch (e) {
                alert('Erro ao salvar: ' + e.message);
            } finally {
                 showLoading('finishOnboardingBtn', false);
            }
        }

        // --- DASHBOARD ---
        function updateDashboardUI() {
            document.getElementById('dashboardSalonName').textContent = currentSalon.name;
            document.documentElement.style.setProperty('--primary-color', currentSalon.primary_color);
            
            // Public Link
            const publicUrl = `${window.location.origin}/?salon=${currentSalon.id}`;
            document.getElementById('publicLink').value = publicUrl;
            document.getElementById('viewPublicPortalBtn').href = publicUrl;

            loadDashboardData();
        }

        function showDashboardPage(page) {
            document.querySelectorAll('.dashboard-page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');

            // Load data based on page
            if (page === 'clients') loadClients();
            if (page === 'services') loadServices();
            if (page === 'stock') loadProducts();
        }

        async function loadDashboardData() {
             // Placeholder: Buscar dados reais do Supabase
             document.getElementById('kpiRevenue').textContent = 'R$ 1.250,00';
             document.getElementById('kpiAppointments').textContent = '12';
             
             // Load IA Insight
             const insightP = document.getElementById('aiInsight');
             try {
                // Simples chamada Gemini (em prod, isso deve ser via Edge Function para seguran√ßa)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${window.ENV.GEMINI_API_KEY}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "D√™ uma dica curta de gest√£o para sal√£o de beleza." }] }] })
                });
                const data = await response.json();
                insightP.textContent = data.candidates[0].content.parts[0].text;
             } catch(e) { insightP.textContent = "Erro ao carregar insight IA."; }

             // Load Chart
             new Chart(document.getElementById('revenueChart'), {
                 type: 'bar', data: { labels: ['Seg','Ter','Qua'], datasets: [{ label: 'Faturamento', data: [300, 450, 500] }]}
             });
        }

        // --- CRUD: CLIENTES ---
        async function loadClients() {
            const { data } = await supabase.from('clients').select('*').eq('salon_id', currentSalon.id).order('name');
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = data.map(c => `
                <tr>
                    <td>${c.name}</td><td>${c.phone}</td><td>${c.last_visit || '-'}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${c.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }
        async function saveClient() {
            const data = { salon_id: currentSalon.id, name: getVal('c_name'), phone: getVal('c_phone'), email: getVal('c_email'), notes: getVal('c_notes') };
            await supabase.from('clients').insert([data]);
            bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
            loadClients();
        }
        async function deleteClient(id) { if(confirm('Excluir?')) { await supabase.from('clients').delete().eq('id', id); loadClients(); }}

         // --- CRUD: SERVI√áOS ---
         async function loadServices() {
            const { data } = await supabase.from('services').select('*').eq('salon_id', currentSalon.id);
            document.getElementById('servicesGrid').innerHTML = data.map(s => `
                <div class="col-md-4 mb-3">
                    <div class="card p-3 ${s.active ? '' : 'bg-light'}">
                        <h6>${s.name}</h6>
                        <p class="mb-1">R$ ${s.price} ‚Ä¢ ${s.duration} min</p>
                        <button class="btn btn-sm btn-danger" onclick="deleteService('${s.id}')">Excluir</button>
                    </div>
                </div>
            `).join('');
         }
         async function saveService() {
             const data = { salon_id: currentSalon.id, name: getVal('s_name'), price: getVal('s_price'), duration: getVal('s_duration'), active: document.getElementById('s_active').checked };
             await supabase.from('services').insert([data]);
             bootstrap.Modal.getInstance(document.getElementById('serviceModal')).hide();
             loadServices();
         }
         async function deleteService(id) { await supabase.from('services').delete().eq('id', id); loadServices(); }

         // --- CRUD: ESTOQUE (Com IA) ---
         async function loadProducts() {
             const { data } = await supabase.from('products').select('*').eq('salon_id', currentSalon.id);
             document.getElementById('productsGrid').innerHTML = data.map(p => `
                <div class="col-md-4 mb-3"><div class="card p-3">
                    <h6>${p.name} <span class="badge bg-secondary">${p.category}</span></h6>
                    <p>Qtd: ${p.quantity}</p>
                </div></div>
             `).join('');
         }
         async function saveProduct() {
             const data = { salon_id: currentSalon.id, name: getVal('p_name'), category: getVal('p_category'), quantity: getVal('p_quantity'), description: getVal('p_desc') };
             await supabase.from('products').insert([data]);
             bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
             loadProducts();
         }
         async function generateProductDescription() {
             const name = getVal('p_name');
             if (!name) return;
             // Chamada IA
             document.getElementById('p_desc').value = `Descri√ß√£o IA para ${name}... (Implementar chamada real)`;
         }

         function getVal(id) { return document.getElementById(id).value; }


        // --- PORTAL P√öBLICO (Client View) ---
        async function loadPublicPortal(salonId) {
            showScreen('publicPortal');
            const { data: salon } = await supabase.from('salons').select('*').eq('id', salonId).single();
            if (!salon) return alert('Sal√£o n√£o encontrado');

            document.getElementById('publicSalonName').textContent = salon.name;
            document.documentElement.style.setProperty('--primary-color', salon.primary_color);

            // Carregar servi√ßos
            const { data: services } = await supabase.from('services').select('*').eq('salon_id', salonId).eq('active', true);
            const select = document.getElementById('bookingService');
            select.innerHTML = services.map(s => `<option value="${s.id}">${s.name} (R$ ${s.price})</option>`).join('');

            // Configurar data m√≠nima
            document.getElementById('bookingDate').min = new Date().toISOString().split('T')[0];
        }

        async function loadTimeSlots() {
            const date = getVal('bookingDate');
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';

            if (!date) return;

            // Simples: Gerar hor√°rios das 9h √†s 17h
            for (let h = 9; h < 17; h++) {
                const time = `${h.toString().padStart(2, '0')}:00`;
                const btn = document.createElement('div');
                btn.className = 'time-slot available';
                btn.textContent = time;
                btn.onclick = () => {
                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById('bookingTime').value = time;
                };
                container.appendChild(btn);
            }
        }

        async function submitPublicBooking(e) {
            e.preventDefault();
            const salonId = new URLSearchParams(window.location.search).get('salon');

            const data = {
                salon_id: salonId,
                service_id: getVal('bookingService'),
                client_name: getVal('bookingName'),
                client_phone: getVal('bookingPhone'),
                booking_date: getVal('bookingDate'),
                booking_time: getVal('bookingTime'),
            };

            try {
                const { error } = await supabase.from('public_bookings').insert([data]);
                if (error) throw error;
                alert('Agendamento solicitado! Entraremos em contato.');
                document.getElementById('publicBookingForm').reset();
            } catch(e) { alert(e.message); }
        }

        // Verificar se √© acesso ao portal p√∫blico
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('salon')) {
            loadPublicPortal(urlParams.get('salon'));
        }

        // --- PWA ---
        function initPWA() {
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('pwaInstallPrompt').classList.add('show');
            });
            document.getElementById('installPWA').addEventListener('click', async () => {
                deferredPrompt.prompt();
                document.getElementById('pwaInstallPrompt').classList.remove('show');
            });
            document.getElementById('dismissInstall').addEventListener('click', () => {
                 document.getElementById('pwaInstallPrompt').classList.remove('show');
            });
        }

        // --- CHATBOT (Simples) ---
        function initChatbot() {
            const toggle = document.getElementById('chatbotToggle');
            const win = document.getElementById('chatbotWindow');
            toggle.onclick = () => win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
            document.getElementById('closeChatbot').onclick = () => win.style.display = 'none';

            document.getElementById('chatSendBtn').onclick = sendMessage;
            document.getElementById('chatInput').onkeypress = (e) => e.key === 'Enter' && sendMessage();

            function sendMessage() {
                const input = document.getElementById('chatInput');
                if (!input.value) return;

                addMessage(input.value, 'user');
                
                // Resposta simples do bot
                setTimeout(() => {
                    addMessage("Recebi sua mensagem. O chatbot completo requer integra√ß√£o com IA (ex: Dialogflow ou Gemini) para respostas complexas.", 'bot');
                }, 1000);

                input.value = '';
            }

            function addMessage(text, type) {
                const div = document.createElement('div');
                div.className = `chat-message ${type}`;
                div.innerHTML = `<div class="message-bubble ${type}">${text}</div>`;
                document.getElementById('chatbotMessages').appendChild(div);
                document.getElementById('chatbotMessages').scrollTop = 999999;
            }
        }

    </script>
</body>
</html>
